name: Contact Form Health Monitor

on:
  schedule:
    # Run every 6 hours (4 times per day) - not too spammy
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  PRODUCTION_URL: https://www.cloudevolvers.com
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}  # Optional

jobs:
  health-check:
    runs-on: ubuntu-latest
    name: Check Contact Form API Health
    
    steps:
      - name: Check Health Endpoint
        id: health
        run: |
          echo "ðŸ¥ Checking health endpoint..."
          HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.PRODUCTION_URL }}/api/health" || echo "FAILED")
          HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
          BODY=$(echo "$HEALTH_RESPONSE" | head -n -1)
          
          echo "health_status=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "Health Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Health check failed with status $HTTP_CODE"
            echo "health_ok=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Health check passed"
            echo "health_ok=true" >> $GITHUB_OUTPUT
          fi

      - name: Test Submit Consultation Endpoint (OPTIONS)
        id: consultation
        run: |
          echo "ðŸ“¬ Checking submit-consultation endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X OPTIONS "${{ env.PRODUCTION_URL }}/api/submit-consultation" \
            -H "Content-Type: application/json" \
            -H "Origin: https://www.cloudevolvers.com" || echo "FAILED")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          echo "consultation_status=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "Consultation Endpoint Status: $HTTP_CODE"
          
          # OPTIONS should return 200 or 204
          if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "204" ]; then
            echo "âœ… Submit consultation endpoint is accessible"
            echo "consultation_ok=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Submit consultation endpoint check failed with status $HTTP_CODE"
            echo "consultation_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue on Failure
        if: steps.health.outputs.health_ok == 'false' || steps.consultation.outputs.consultation_ok == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const healthStatus = '${{ steps.health.outputs.health_status }}';
            const consultationStatus = '${{ steps.consultation.outputs.consultation_status }}';
            const healthOk = '${{ steps.health.outputs.health_ok }}' === 'true';
            const consultationOk = '${{ steps.consultation.outputs.consultation_ok }}' === 'true';
            
            // Check for existing open issues with this title
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'monitoring,critical'
            });
            
            const alertTitle = 'ðŸš¨ Contact Form API Health Alert';
            const hasExistingAlert = existingIssues.data.some(issue => 
              issue.title.includes('Contact Form API Health Alert')
            );
            
            if (hasExistingAlert) {
              console.log('An alert issue already exists, skipping creation to avoid spam');
              return;
            }
            
            const body = `## ðŸš¨ Contact Form API Health Check Failed
            
            **Detected at:** ${new Date().toISOString()}
            
            ### Status Summary
            | Endpoint | Status | Result |
            |----------|--------|--------|
            | /api/health | ${healthStatus} | ${healthOk ? 'âœ… OK' : 'âŒ FAILED'} |
            | /api/submit-consultation | ${consultationStatus} | ${consultationOk ? 'âœ… OK' : 'âŒ FAILED'} |
            
            ### Action Required
            Please investigate the Azure Functions deployment and ensure:
            1. The Azure Function App is running
            2. Environment variables are configured correctly
            3. CORS settings allow the production domain
            
            ### How to Close
            Close this issue once the problem is resolved. The next health check will create a new issue if problems persist.
            
            ---
            *This issue was automatically created by the Contact Form Health Monitor workflow.*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: alertTitle,
              body: body,
              labels: ['monitoring', 'critical', 'automated']
            });
            
            console.log('Created alert issue');

      - name: Summary
        run: |
          echo "## Contact Form Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| /api/health | ${{ steps.health.outputs.health_ok == 'true' && 'âœ… OK' || 'âŒ FAILED' }} (${{ steps.health.outputs.health_status }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| /api/submit-consultation | ${{ steps.consultation.outputs.consultation_ok == 'true' && 'âœ… OK' || 'âŒ FAILED' }} (${{ steps.consultation.outputs.consultation_status }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY
