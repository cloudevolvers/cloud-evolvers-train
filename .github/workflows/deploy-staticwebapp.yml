# ğŸš€ DEPLOYMENT WORKFLOW - Combined Build & Deploy with Parallel Setup
# Single Source of Truth: production.env + GitHub Secrets
name: Deploy Azure Static Web App

on:
  push:
    branches: [ "main", "feature/*", "fix/*", "hotfix/*" ]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [ "main" ]
  delete:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (dev, staging, or prod)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

# Concurrency: queue deployments per branch+event, never cancel in-progress
# Uses event_name to prevent delete events from affecting push deployments
concurrency:
  group: deploy-swa-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: read

jobs:
  # ğŸ”§ JOB 1: Setup Environment Variables
  setup-env:
    name: Setup Environment Variables
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Target Environment
        id: determine-env
        run: |
          echo "ğŸ¯ Determining deployment environment..."
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            ENVIRONMENT="staging"
            ENV_FILE=".github/workflows/DeploymentVars/staging.env"
            echo "ğŸ“‹ Pull Request â†’ Staging environment (unique per PR, auto-cleanup)"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            ENVIRONMENT="production"
            ENV_FILE=".github/workflows/DeploymentVars/production.env"
            echo "ğŸŒ Main branch â†’ Production environment"
          else
            ENVIRONMENT="dev"
            ENV_FILE=".github/workflows/DeploymentVars/dev.env"
            echo "ğŸ”§ Feature/other branch â†’ Dev environment (overwrites previous)"
          fi
          
          echo ""
          echo "ğŸ¯ Target Environment: $ENVIRONMENT"
          echo "ğŸ“„ Config File: $ENV_FILE"
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "env_file=$ENV_FILE" >> $GITHUB_OUTPUT

      - name: Load Environment Variables
        run: |
          echo "ğŸ”§ Loading environment variables (single source of truth)..."
          echo ""
          
          ENV_FILE="${{ steps.determine-env.outputs.env_file }}"
          echo "ğŸ“„ Using: $ENV_FILE"
          
          # Load environment variables using utility script
          bash .github/workflows/scripts/deployment-utils.sh load-env "$ENV_FILE"
          
          echo "âœ… Environment variables loaded successfully"

      - name: Load Secrets Mapping
        id: load-secrets
        run: |
          echo "ğŸ” Loading secrets from secrets-mapping.yml (dynamic configuration)..."
          echo ""
          echo "ğŸ“Š Why GitHub Secrets?"
          echo "  â€¢ Key Vault integration ONLY works for production Static Web Apps"
          echo "  â€¢ Staging/preview environments do NOT support Key Vault"
          echo "  â€¢ GitHub Secrets work for ALL environments (dev/staging/prod)"
          echo ""
          
          # Run the dynamic secrets loader to show what will be loaded
          chmod +x .github/workflows/scripts/load-secrets.sh
          bash .github/workflows/scripts/load-secrets.sh
          
          echo ""
          echo "ğŸ”‘ Applying Secret Overrides..."

      - name: Process @GitHubActions= Secrets (Automatic)
        run: |
          echo "ğŸ” Processing @GitHubActions= syntax from production.env..."
          echo ""
          
          # Show what we're processing
          chmod +x .github/workflows/scripts/process-github-secrets.sh
          bash .github/workflows/scripts/process-github-secrets.sh
          
          echo ""
          echo "ğŸ”‘ Auto-loading secrets from production.env..."
          
          # Process each line with @GitHubActions= syntax
          while IFS= read -r line || [[ -n "$line" ]]; do
            # Match pattern: VAR_NAME=@GitHubActions=SECRET_NAME
            if [[ "$line" =~ ^([A-Z_]+)=@GitHubActions=([A-Z_]+) ]]; then
              ENV_VAR="${BASH_REMATCH[1]}"
              SECRET_NAME="${BASH_REMATCH[2]}"
              
              # Get the secret value dynamically
              case "$SECRET_NAME" in
                "API_KEY")
                  if [[ -n "${{ secrets.API_KEY }}" ]]; then
                    echo "${ENV_VAR}=${{ secrets.API_KEY }}" >> $GITHUB_ENV
                    echo "  âœ… $ENV_VAR â† GitHub Secret: $SECRET_NAME"
                  else
                    echo "  âš ï¸  WARNING: $SECRET_NAME not found in GitHub Secrets"
                  fi
                  ;;
                "EMAIL_AZURE_CLIENT_SECRET")
                  if [[ -n "${{ secrets.EMAIL_AZURE_CLIENT_SECRET }}" ]]; then
                    echo "${ENV_VAR}=${{ secrets.EMAIL_AZURE_CLIENT_SECRET }}" >> $GITHUB_ENV
                    echo "  âœ… $ENV_VAR â† GitHub Secret: $SECRET_NAME"
                  else
                    echo "  âš ï¸  WARNING: $SECRET_NAME not found in GitHub Secrets"
                  fi
                  ;;
                "VITE_AZURE_AD_CLIENT_SECRET")
                  if [[ -n "${{ secrets.VITE_AZURE_AD_CLIENT_SECRET }}" ]]; then
                    echo "${ENV_VAR}=${{ secrets.VITE_AZURE_AD_CLIENT_SECRET }}" >> $GITHUB_ENV
                    echo "  âœ… $ENV_VAR â† GitHub Secret: $SECRET_NAME"
                  fi
                  ;;
                *)
                  echo "  â„¹ï¸  Skipping: $SECRET_NAME (not configured in workflow yet)"
                  ;;
              esac
            fi
          done < .github/workflows/DeploymentVars/production.env
          
          echo ""
          echo "ğŸ“‹ Configuration Summary:"
          echo "  ğŸ“ Base: production.env (single source of truth)"
          echo "  ğŸ” Syntax: @GitHubActions=SECRET_NAME"
          echo "  ğŸ”‘ Values: GitHub Secrets (auto-loaded)"
          echo "  ğŸš« Key Vault: NOT used (doesn't work for staging)"
          echo ""
          echo "ğŸ’¡ To add new secrets:"
          echo "  1. Add secret to GitHub Settings"
          echo "  2. Add to production.env: MY_VAR=@GitHubActions=MY_SECRET"
          echo "  3. Add case to workflow (or use generic handler)"
          echo "  4. Push and deploy!"

  # ğŸ—ï¸ JOB 2: Build and Deploy (Combined)
  build_and_deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: setup-env
    environment: ${{ needs.setup-env.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          for i in 1 2 3; do
            npm ci --legacy-peer-deps && break
            echo "Retry $i failed, waiting 30s..."
            sleep 30
            if [ $i -eq 3 ]; then
              echo "All retries failed"
              exit 1
            fi
          done

      - name: Set build date
        id: build-date
        run: echo "date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Build application
        run: npm run build
        env:
          # Pass environment variables from production.env
          NODE_ENV: production
          # Version and environment tracking
          VITE_COMMIT_SHA: ${{ github.sha }}
          VITE_ENVIRONMENT: ${{ needs.setup-env.outputs.environment }}
          VITE_BUILD_DATE: ${{ steps.build-date.outputs.date }}
          # GitHub Secrets override production.env values
          VITE_API_KEY: ${{ secrets.API_KEY }}
          EMAIL_AZURE_CLIENT_SECRET: ${{ secrets.EMAIL_AZURE_CLIENT_SECRET }}
          API_KEY: ${{ secrets.API_KEY }}

      - name: Clean up before deploy
        run: |
          echo "Removing unnecessary files to reduce deploy size..."
          rm -rf node_modules
          rm -rf migration-files
          rm -rf backup-original-images
          rm -rf image-server
          rm -rf docs
          rm -rf pids
          rm -rf .git
          echo "Cleaned up workspace"
          du -sh . || true
          ls -la

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/dist"
          api_location: "api"
          output_location: ""
          skip_app_build: true
          skip_api_build: false
          production_branch: "main"
          # Azure Static Web Apps automatically creates preview environments for PRs
          # Only use named environment for feature branches
          deployment_environment: ${{ github.event_name == 'pull_request' && '' || (github.ref_name != 'main' && 'dev') || '' }}
        env:
          # Pass secrets to Static Web App environment
          API_KEY: ${{ secrets.API_KEY }}
          VITE_API_KEY: ${{ secrets.API_KEY }}
          EMAIL_AZURE_CLIENT_SECRET: ${{ secrets.EMAIL_AZURE_CLIENT_SECRET }}

      - name: Deployment Success
        if: success()
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸ” Secrets: Loaded from GitHub Secrets via @GitHubActions= syntax"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ¯ Environment: ${{ needs.setup-env.outputs.environment }}"
          echo ""
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ğŸ§ª PR PREVIEW ENVIRONMENT (Automatic)                        â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“ Config: staging.env"
            echo "ğŸ”— URL: Check PR comments for preview URL (auto-generated by Azure)"
            echo "â™»ï¸  Auto-cleanup: Preview deleted when PR is merged or closed"
            echo "ğŸ’¡ Azure automatically creates unique preview environments for PRs"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ğŸŒ PRODUCTION ENVIRONMENT                                     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“ Config: production.env"
            echo "ğŸ”— URL: https://witty-desert-0f02b4903.2.azurestaticapps.net"
            echo "âœ… Stable production deployment"
          else
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ğŸ”§ DEV ENVIRONMENT (Feature Branch)                          â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“ Config: dev.env"
            echo "ğŸ”— URL: https://witty-desert-0f02b4903-dev.westeurope.2.azurestaticapps.net"
            echo "âš ï¸  Overwrites: Previous dev deployment replaced"
          fi

  # ğŸ·ï¸ JOB 3: Version Bump (creates PR to bypass branch protection)
  version-bump:
    name: Bump Version
    runs-on: ubuntu-latest
    needs: build_and_deploy
    # Only run on main branch, not on version bump PRs or skip ci commits
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && !contains(github.event.head_commit.message || '', '[skip ci]') && !contains(github.event.head_commit.message || '', 'ğŸ·ï¸ Auto-bump version')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Bump version and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ·ï¸ Bumping version for main branch commit..."
          
          # Get current version
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Parse and bump version
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          echo "New version: $NEW_VERSION"
          
          # Create branch for version bump
          BRANCH_NAME="auto/version-bump-$NEW_VERSION"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "â„¹ï¸ Version bump branch already exists, skipping"
            exit 0
          fi
          
          git checkout -b "$BRANCH_NAME"
          
          # Update package.json
          sed -i "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"$NEW_VERSION\"/" package.json
          
          # Update version.ts - just update the version number using sed
          sed -i "s/version: '$CURRENT_VERSION'/version: '$NEW_VERSION'/" src/lib/version.ts
          
          # Commit and push
          git add package.json src/lib/version.ts
          git commit -m "ğŸ·ï¸ Auto-bump version to $NEW_VERSION [skip ci]"
          git push origin "$BRANCH_NAME"
          
          # Try to create PR with auto-merge (may fail if GITHUB_TOKEN lacks permissions)
          echo "ğŸ“ Creating PR for version bump..."
          if gh pr create \
            --title "ğŸ·ï¸ Auto-bump version to $NEW_VERSION" \
            --body "Automated version bump after successful deployment.

          **Changes:**
          - Version: $CURRENT_VERSION â†’ $NEW_VERSION
          - Updated package.json
          - Updated src/lib/version.ts

          This PR was automatically created by GitHub Actions." \
            --base main \
            --head "$BRANCH_NAME" 2>&1; then
            
            # Enable auto-merge
            gh pr merge "$BRANCH_NAME" --auto --squash 2>&1 || echo "âš ï¸ Could not enable auto-merge"
            echo "âœ… Version bump PR created and auto-merge enabled"
          else
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âš ï¸  MANUAL ACTION REQUIRED                                    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Branch pushed but could not create PR automatically."
            echo "Please create the PR manually:"
            echo ""
            echo "  ğŸ”— https://github.com/xevolve-org/cloud-evolvers-train/pull/new/$BRANCH_NAME"
            echo ""
            echo "To enable automatic PR creation, add a PAT with 'pull_request: write'"
            echo "permission as a secret named 'REPO_PAT'."
            echo ""
          fi

  # ğŸ§¹ CLEANUP: Close Pull Request Environment
  close_pull_request:
    name: Close Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Close staging environment
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "close"
          app_location: "/"
      
      - name: Cleanup summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ§¹ PR PREVIEW ENVIRONMENT CLEANUP                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ PR #${{ github.event.pull_request.number }} was ${{ github.event.action }}"
          echo "ğŸ—‘ï¸  Preview environment has been deleted"
          echo "âœ… Cleanup complete!"

  # ğŸ§¹ CLEANUP: Remove dev environment when branches are deleted
  cleanup_staging:
    name: Cleanup Dev Environment
    runs-on: ubuntu-latest
    if: false  # Disabled - dev environments auto-cleanup, no separate run needed
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.XEVOLVE_DEPLOY_CI_CD_SPN_APP_ID }}",
              "clientSecret": "${{ secrets.XEVOLVE_DEPLOY_CI_CD_SPN_SECRET }}",
              "tenantId": "34dd9821-1508-4858-974c-e5fd1493a58f",
              "subscriptionId": "4a55c776-9f6b-4966-921e-c9f60e50652f"
            }

      - name: Cleanup dev environment
        run: |
          BRANCH_NAME="${{ github.event.ref }}"
          
          echo "ğŸ§¹ Cleanup for deleted branch: $BRANCH_NAME"
          
          if [[ "$BRANCH_NAME" != "main" ]]; then
            echo "ğŸ” Checking for dev environment..."
            
            DEV_EXISTS=$(az staticwebapp environment list \
              --name "cloudevolvers-website-swa" \
              --resource-group "cloudevolvers-p-websites-rg" \
              --subscription "4a55c776-9f6b-4966-921e-c9f60e50652f" \
              --query "[?name=='dev'].name | [0]" -o tsv 2>/dev/null || echo "")
            
            if [[ -n "$DEV_EXISTS" && "$DEV_EXISTS" != "null" ]]; then
              echo "ğŸ—‘ï¸ Deleting dev environment"
              az staticwebapp environment delete \
                --name "cloudevolvers-website-swa" \
                --resource-group "cloudevolvers-p-websites-rg" \
                --subscription "4a55c776-9f6b-4966-921e-c9f60e50652f" \
                --environment-name "dev" --yes
              echo "âœ… Dev environment deleted"
            else
              echo "â„¹ï¸ No dev environment to clean up"
            fi
          fi
