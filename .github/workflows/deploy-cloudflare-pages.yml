# ğŸš€ Cloudflare Pages Deployment Workflow
# Deploys to poc.cloudevolvers.com on Cloudflare Pages
name: Deploy to Cloudflare Pages

on:
  push:
    branches: ["main", "feature/*", "fix/*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - poc
          - dev
          - production
        default: 'poc'

concurrency:
  group: deploy-cf-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write
  id-token: write  # Required for Azure Key Vault OIDC

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'poc' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Optional: Azure Key Vault Secrets Retrieval
      # Uncomment this section if using Azure Key Vault for secrets management
      # - name: Azure Login
      #   uses: azure/login@v2
      #   with:
      #     client-id: ${{ secrets.AZURE_CLIENT_ID }}
      #     tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      #     subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      #
      # - name: Get secrets from Azure Key Vault
      #   uses: azure/get-keyvault-secrets@v1
      #   with:
      #     keyvault: 'cloudevolvers-kv'
      #     secrets: 'api-key,azure-ad-client-id,azure-ad-tenant-id,email-client-secret'
      #   id: keyvault

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Cloudflare Workers types
        run: npm install --save-dev @cloudflare/workers-types --legacy-peer-deps

      - name: Set build date
        id: build-date
        run: echo "date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          VITE_COMMIT_SHA: ${{ github.sha }}
          VITE_ENVIRONMENT: ${{ github.event.inputs.environment || 'poc' }}
          VITE_BUILD_DATE: ${{ steps.build-date.outputs.date }}
          # Frontend environment variables (public)
          VITE_API_KEY: ${{ secrets.API_KEY }}
          VITE_AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
          VITE_AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Configure Cloudflare Pages Secrets
        run: |
          echo "ğŸ“¦ Configuring Cloudflare Pages secrets..."

          # Set secrets for the Pages project (these are used by Functions)
          echo "${{ secrets.API_KEY }}" | wrangler pages secret put API_KEY --project-name=cloud-evolvers-train 2>/dev/null || true
          echo "${{ secrets.AZURE_AD_CLIENT_ID }}" | wrangler pages secret put AZURE_AD_CLIENT_ID --project-name=cloud-evolvers-train 2>/dev/null || true
          echo "${{ secrets.AZURE_AD_TENANT_ID }}" | wrangler pages secret put AZURE_AD_TENANT_ID --project-name=cloud-evolvers-train 2>/dev/null || true
          echo "${{ secrets.EMAIL_AZURE_CLIENT_SECRET }}" | wrangler pages secret put EMAIL_AZURE_CLIENT_SECRET --project-name=cloud-evolvers-train 2>/dev/null || true
          echo "${{ secrets.ADMIN_PASSWORD }}" | wrangler pages secret put ADMIN_PASSWORD --project-name=cloud-evolvers-train 2>/dev/null || true

          echo "âœ… Secrets configured"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages
        id: deploy
        run: |
          OUTPUT=$(wrangler pages deploy dist --project-name=cloud-evolvers-train --branch=${{ github.ref_name }} 2>&1)
          echo "$OUTPUT"

          # Extract deployment URL
          DEPLOYMENT_URL=$(echo "$OUTPUT" | grep -oP 'https://[^\s]+\.pages\.dev' | head -1 || echo "")
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment Summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ‰ DEPLOYMENT SUCCESSFUL                                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Project: cloud-evolvers-train"
          echo "ğŸŒ¿ Branch:  ${{ github.ref_name }}"
          echo "ğŸ”‘ Commit:  ${{ github.sha }}"
          echo ""

          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "ğŸŒ Environment: Production (POC)"
            echo ""
            echo "ğŸ“¡ URLs:"
            echo "   â€¢ Primary:    https://poc.cloudevolvers.com"
            echo "   â€¢ Cloudflare: https://cloud-evolvers-train.pages.dev"
            echo ""
            echo "ğŸ”Œ API Endpoints:"
            echo "   â€¢ Contact:    https://cloud-evolvers-train.pages.dev/api/submit-consultation"
            echo "   â€¢ Pricing:    https://cloud-evolvers-train.pages.dev/api/pricing"
          else
            echo "ğŸ”§ Environment: Preview"
            echo ""
            echo "ğŸ“¡ Preview URL: ${{ steps.deploy.outputs.deployment_url }}"
          fi
          echo ""
