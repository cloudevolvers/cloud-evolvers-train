# Secret Expiry Monitor
# Checks Azure AD app client secret expiration and sends alerts
name: Secret Expiry Monitor

on:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Send test alert regardless of expiry status'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  check-secret-expiry:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.XEVOLVE_DEPLOY_CI_CD_SPN_APP_ID }}
          tenant-id: ${{ secrets.XEVOLVE_DEPLOY_CI_CD_SPN_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: false

      - name: Check App Registration Secret Expiry
        id: check-expiry
        env:
          APP_ID: e66fa949-5dad-4067-b01b-587088d16796
          ALERT_DAYS: 30
          TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        run: |
          echo "Checking secret expiry for app: $APP_ID"
          
          # Get app credentials using Azure CLI
          CREDENTIALS=$(az ad app credential list --id "$APP_ID" --query "[].{keyId:keyId,displayName:displayName,endDateTime:endDateTime}" -o json 2>/dev/null || echo "[]")
          
          if [ "$CREDENTIALS" == "[]" ]; then
            echo "Warning: No credentials found or unable to query app"
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "message=Unable to query app credentials. Please check permissions." >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found credentials:"
          echo "$CREDENTIALS" | jq .
          
          # Get current date in seconds since epoch
          NOW=$(date +%s)
          
          # Check each credential
          EXPIRING_SOON=""
          EXPIRED=""
          HEALTHY=""
          
          for row in $(echo "$CREDENTIALS" | jq -r '.[] | @base64'); do
            _jq() {
              echo ${row} | base64 --decode | jq -r ${1}
            }
            
            END_DATE=$(_jq '.endDateTime')
            KEY_ID=$(_jq '.keyId')
            DISPLAY_NAME=$(_jq '.displayName')
            
            # Convert end date to epoch seconds
            END_EPOCH=$(date -d "$END_DATE" +%s 2>/dev/null || echo "0")
            
            if [ "$END_EPOCH" == "0" ]; then
              echo "Warning: Could not parse date: $END_DATE"
              continue
            fi
            
            DAYS_LEFT=$(( (END_EPOCH - NOW) / 86400 ))
            
            if [ $DAYS_LEFT -lt 0 ]; then
              echo "EXPIRED: $DISPLAY_NAME (Key: ${KEY_ID:0:8}...) - Expired $((DAYS_LEFT * -1)) days ago"
              EXPIRED="$EXPIRED- $DISPLAY_NAME: Expired $((DAYS_LEFT * -1)) days ago\n"
            elif [ $DAYS_LEFT -lt $ALERT_DAYS ]; then
              echo "EXPIRING SOON: $DISPLAY_NAME (Key: ${KEY_ID:0:8}...) - $DAYS_LEFT days left"
              EXPIRING_SOON="$EXPIRING_SOON- $DISPLAY_NAME: $DAYS_LEFT days remaining (expires $END_DATE)\n"
            else
              echo "HEALTHY: $DISPLAY_NAME (Key: ${KEY_ID:0:8}...) - $DAYS_LEFT days left"
              HEALTHY="$HEALTHY- $DISPLAY_NAME: $DAYS_LEFT days remaining\n"
            fi
          done
          
          # Determine overall status
          if [ -n "$EXPIRED" ]; then
            echo "status=expired" >> $GITHUB_OUTPUT
            echo "message=CRITICAL: Some secrets have EXPIRED! $EXPIRED" >> $GITHUB_OUTPUT
            echo "should_alert=true" >> $GITHUB_OUTPUT
          elif [ -n "$EXPIRING_SOON" ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "message=WARNING: Secrets expiring within $ALERT_DAYS days: $EXPIRING_SOON" >> $GITHUB_OUTPUT
            echo "should_alert=true" >> $GITHUB_OUTPUT
          else
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "message=All secrets are healthy: $HEALTHY" >> $GITHUB_OUTPUT
            echo "should_alert=false" >> $GITHUB_OUTPUT
          fi
          
          # Force alert in test mode
          if [ "$TEST_MODE" == "true" ]; then
            echo "Test mode enabled - forcing alert"
            echo "should_alert=true" >> $GITHUB_OUTPUT
          fi

      - name: Send Alert Email
        if: steps.check-expiry.outputs.should_alert == 'true'
        env:
          EMAIL_AZURE_TENANT_ID: 34dd9821-1508-4858-974c-e5fd1493a58f
          EMAIL_AZURE_CLIENT_ID: e66fa949-5dad-4067-b01b-587088d16796
          EMAIL_AZURE_CLIENT_SECRET: ${{ secrets.EMAIL_AZURE_CLIENT_SECRET }}
          STATUS: ${{ steps.check-expiry.outputs.status }}
          MESSAGE: ${{ steps.check-expiry.outputs.message }}
        run: |
          echo "Sending alert email..."
          
          # Get access token for Microsoft Graph
          TOKEN_RESPONSE=$(curl -s -X POST \
            "https://login.microsoftonline.com/$EMAIL_AZURE_TENANT_ID/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$EMAIL_AZURE_CLIENT_ID" \
            -d "client_secret=$EMAIL_AZURE_CLIENT_SECRET" \
            -d "scope=https://graph.microsoft.com/.default" \
            -d "grant_type=client_credentials")
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          
          if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "Failed to get access token"
            echo "$TOKEN_RESPONSE"
            exit 1
          fi
          
          # Determine email subject based on status
          if [ "$STATUS" == "expired" ]; then
            SUBJECT="CRITICAL: Azure AD Secret Has EXPIRED - Cloud Evolvers"
          elif [ "$STATUS" == "warning" ]; then
            SUBJECT="WARNING: Azure AD Secret Expiring Soon - Cloud Evolvers"
          else
            SUBJECT="Secret Expiry Check - Cloud Evolvers"
          fi
          
          # Create email content
          EMAIL_CONTENT="Secret Expiry Alert for Cloud Evolvers\n\nStatus: $STATUS\n\n$MESSAGE\n\nWhat to do:\n1. Go to Azure Portal - App Registrations\n2. Create a new client secret\n3. Update the GitHub secret EMAIL_AZURE_CLIENT_SECRET\n4. Delete the old/expired secret\n\nApp ID: e66fa949-5dad-4067-b01b-587088d16796\nAzure Portal Link: https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/Credentials/appId/e66fa949-5dad-4067-b01b-587088d16796\n\nCheck performed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Escape for JSON
          EMAIL_ESCAPED=$(echo -e "$EMAIL_CONTENT" | jq -Rs .)
          
          # Send email via Microsoft Graph
          SEND_RESPONSE=$(curl -s -X POST \
            "https://graph.microsoft.com/v1.0/users/internalautomation@xevolve.io/sendMail" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"message\": {
                \"subject\": \"$SUBJECT\",
                \"body\": {
                  \"contentType\": \"Text\",
                  \"content\": $EMAIL_ESCAPED
                },
                \"toRecipients\": [
                  {
                    \"emailAddress\": {
                      \"address\": \"yair@cloudevolvers.com\",
                      \"name\": \"Yair\"
                    }
                  }
                ]
              },
              \"saveToSentItems\": true
            }")
          
          if [ -z "$SEND_RESPONSE" ]; then
            echo "Alert email sent successfully to yair@cloudevolvers.com"
          else
            echo "Email response: $SEND_RESPONSE"
          fi

      - name: Summary
        run: |
          echo "## Secret Expiry Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.check-expiry.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Details:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.check-expiry.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-expiry.outputs.should_alert }}" == "true" ]; then
            echo "Alert email sent to yair@cloudevolvers.com" >> $GITHUB_STEP_SUMMARY
          else
            echo "No alert needed - all secrets healthy" >> $GITHUB_STEP_SUMMARY
          fi
