name: ðŸ—ï¸ Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy infrastructure'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - production
        - both

env:
  CONFIG_FILE: deployment-config.json
  AZURE_CLIENT_ID: 1f29ef36-137d-47f6-bbab-7b85b50a8567

jobs:
  prepare-infrastructure-deployment:
    name: ðŸ“‹ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      dev-config: ${{ steps.parse-config.outputs.dev-config }}
      prod-config: ${{ steps.parse-config.outputs.prod-config }}
      global-config: ${{ steps.parse-config.outputs.global-config }}
      deploy-dev: ${{ steps.determine-deployment.outputs.deploy-dev }}
      deploy-prod: ${{ steps.determine-deployment.outputs.deploy-prod }}
      
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ”§ Parse Deployment Configuration
      id: parse-config
      run: |
        echo "ðŸ“‹ Reading deployment configuration from $CONFIG_FILE"
        
        # Read and parse the JSON configuration
        DEV_CONFIG=$(jq -c '.environments.development' $CONFIG_FILE)
        PROD_CONFIG=$(jq -c '.environments.production' $CONFIG_FILE)
        GLOBAL_CONFIG=$(jq -c '.global' $CONFIG_FILE)
        
        echo "dev-config=$DEV_CONFIG" >> $GITHUB_OUTPUT
        echo "prod-config=$PROD_CONFIG" >> $GITHUB_OUTPUT  
        echo "global-config=$GLOBAL_CONFIG" >> $GITHUB_OUTPUT

        echo "âœ… Configuration loaded successfully"

    - name: ðŸŽ¯ Determine Infrastructure Deployment Targets
      id: determine-deployment
      run: |
        DEPLOY_DEV="false"
        DEPLOY_PROD="false"
        
        if [ "${{ github.event.inputs.environment }}" == "development" ]; then
          DEPLOY_DEV="true"
        elif [ "${{ github.event.inputs.environment }}" == "production" ]; then
          DEPLOY_PROD="true"
        elif [ "${{ github.event.inputs.environment }}" == "both" ]; then
          DEPLOY_DEV="true"
          DEPLOY_PROD="true"
        fi
        
        echo "deploy-dev=$DEPLOY_DEV" >> $GITHUB_OUTPUT
        echo "deploy-prod=$DEPLOY_PROD" >> $GITHUB_OUTPUT
        
        echo "ðŸŽ¯ Infrastructure Deployment Targets:"
        echo "  Development: $DEPLOY_DEV"
        echo "  Production: $DEPLOY_PROD"

  deploy-development-infrastructure:
    name: ðŸ—ï¸ Deploy Development Infrastructure
    runs-on: ubuntu-latest
    needs: prepare-infrastructure-deployment
    if: needs.prepare-infrastructure-deployment.outputs.deploy-dev == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ” Login to Azure
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ env.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.XEVOLVE_DEPLOY_CI_CD_SPN_SECRET }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          }

    - name: ðŸ—ï¸ Deploy Development Bicep Infrastructure
      run: |
        DEV_CONFIG='${{ needs.prepare-infrastructure-deployment.outputs.dev-config }}'
        RESOURCE_GROUP=$(echo $DEV_CONFIG | jq -r '.resourceGroup')
        BICEP_TEMPLATE=$(echo $DEV_CONFIG | jq -r '.bicepTemplate')
        BICEP_PARAMETERS=$(echo $DEV_CONFIG | jq -r '.bicepParameters')
        
        echo "ðŸ—ï¸ Deploying Bicep infrastructure for development environment..."
        echo "ðŸ“‚ Resource Group: $RESOURCE_GROUP"
        echo "ðŸ“„ Bicep Template: $BICEP_TEMPLATE"  
        echo "âš™ï¸ Parameters File: $BICEP_PARAMETERS"
        
        # Check if resource group exists, if not create it
        if ! az group show --name "$RESOURCE_GROUP" --output none 2>/dev/null; then
          echo "ðŸ“¦ Creating resource group: $RESOURCE_GROUP"
          az group create --name "$RESOURCE_GROUP" --location "West Europe" --output table
        else
          echo "âœ… Resource group $RESOURCE_GROUP already exists"
        fi
        
        # Deploy the Bicep template
        echo "ðŸš€ Starting Bicep deployment..."
        az deployment group create \
          --resource-group "$RESOURCE_GROUP" \
          --template-file "$BICEP_TEMPLATE" \
          --parameters "@$BICEP_PARAMETERS" \
          --output table
          
        echo "âœ… Development infrastructure deployment completed"

    - name: âš™ï¸ Configure Development Environment Variables
      run: |
        DEV_CONFIG='${{ needs.prepare-infrastructure-deployment.outputs.dev-config }}'
        FUNCTION_APP=$(echo $DEV_CONFIG | jq -r '.functionAppName')
        RESOURCE_GROUP=$(echo $DEV_CONFIG | jq -r '.resourceGroup')
        
        echo "âš™ï¸ Configuring environment variables for: $FUNCTION_APP"
        
        # Build environment variables from JSON config
        ENV_VARS=""
        
        # Add Key Vault references
        echo $DEV_CONFIG | jq -r '.keyVaultReferences | to_entries[] | "\(.key)=\(.value)"' | while read line; do
          ENV_VARS="$ENV_VARS $line"
        done
        
        # Add app settings
        echo $DEV_CONFIG | jq -r '.appSettings | to_entries[] | "\(.key)=\(.value)"' | while read line; do
          ENV_VARS="$ENV_VARS $line"
        done
        
        # Add deployment timestamp
        ENV_VARS="$ENV_VARS DEPLOYMENT_TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)"
        
        echo "ðŸ”§ Updating Function App configuration..."
        az functionapp config appsettings set \
          --name "$FUNCTION_APP" \
          --resource-group "$RESOURCE_GROUP" \
          --settings $ENV_VARS
          
        echo "âœ… Development environment variables configured"

  deploy-production-infrastructure:
    name: ðŸ—ï¸ Deploy Production Infrastructure
    runs-on: ubuntu-latest
    needs: prepare-infrastructure-deployment
    if: needs.prepare-infrastructure-deployment.outputs.deploy-prod == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ” Login to Azure
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ env.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.XEVOLVE_DEPLOY_CI_CD_SPN_SECRET }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          }

    - name: ðŸ—ï¸ Deploy Production Bicep Infrastructure
      run: |
        PROD_CONFIG='${{ needs.prepare-infrastructure-deployment.outputs.prod-config }}'
        RESOURCE_GROUP=$(echo $PROD_CONFIG | jq -r '.resourceGroup')
        BICEP_TEMPLATE=$(echo $PROD_CONFIG | jq -r '.bicepTemplate')
        BICEP_PARAMETERS=$(echo $PROD_CONFIG | jq -r '.bicepParameters')
        
        echo "ðŸ—ï¸ Deploying Bicep infrastructure for production environment..."
        echo "ðŸ“‚ Resource Group: $RESOURCE_GROUP"
        echo "ðŸ“„ Bicep Template: $BICEP_TEMPLATE"  
        echo "âš™ï¸ Parameters File: $BICEP_PARAMETERS"
        
        # Check if resource group exists, if not create it
        if ! az group show --name "$RESOURCE_GROUP" --output none 2>/dev/null; then
          echo "ðŸ“¦ Creating resource group: $RESOURCE_GROUP"
          az group create --name "$RESOURCE_GROUP" --location "West Europe" --output table
        else
          echo "âœ… Resource group $RESOURCE_GROUP already exists"
        fi
        
        # Deploy the Bicep template
        echo "ðŸš€ Starting Bicep deployment..."
        az deployment group create \
          --resource-group "$RESOURCE_GROUP" \
          --template-file "$BICEP_TEMPLATE" \
          --parameters "@$BICEP_PARAMETERS" \
          --output table
          
        echo "âœ… Production infrastructure deployment completed"

    - name: âš™ï¸ Configure Production Environment Variables
      run: |
        PROD_CONFIG='${{ needs.prepare-infrastructure-deployment.outputs.prod-config }}'
        FUNCTION_APP=$(echo $PROD_CONFIG | jq -r '.functionAppName')
        RESOURCE_GROUP=$(echo $PROD_CONFIG | jq -r '.resourceGroup')
        
        echo "âš™ï¸ Configuring environment variables for: $FUNCTION_APP"
        
        # Build environment variables from JSON config
        ENV_VARS=""
        
        # Add Key Vault references
        echo $PROD_CONFIG | jq -r '.keyVaultReferences | to_entries[] | "\(.key)=\(.value)"' | while read line; do
          ENV_VARS="$ENV_VARS $line"
        done
        
        # Add app settings
        echo $PROD_CONFIG | jq -r '.appSettings | to_entries[] | "\(.key)=\(.value)"' | while read line; do
          ENV_VARS="$ENV_VARS $line"
        done
        
        # Add deployment timestamp
        ENV_VARS="$ENV_VARS DEPLOYMENT_TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)"
        
        echo "ðŸ”§ Updating Function App configuration..."
        az functionapp config appsettings set \
          --name "$FUNCTION_APP" \
          --resource-group "$RESOURCE_GROUP" \
          --settings $ENV_VARS
          
        echo "âœ… Production environment variables configured"

  infrastructure-deployment-summary:
    name: ðŸ“‹ Infrastructure Deployment Summary
    runs-on: ubuntu-latest
    needs: [prepare-infrastructure-deployment, deploy-development-infrastructure, deploy-production-infrastructure]
    if: always()
    
    steps:
    - name: ðŸ“‹ Display Deployment Summary
      run: |
        echo "## ðŸ—ï¸ Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.prepare-infrastructure-deployment.outputs.deploy-dev }}" == "true" ]; then
          if [ "${{ needs.deploy-development-infrastructure.result }}" == "success" ]; then
            echo "âœ… **Development Infrastructure**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Development Infrastructure**: Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â­ï¸ **Development Infrastructure**: Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.prepare-infrastructure-deployment.outputs.deploy-prod }}" == "true" ]; then
          if [ "${{ needs.deploy-production-infrastructure.result }}" == "success" ]; then
            echo "âœ… **Production Infrastructure**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Production Infrastructure**: Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â­ï¸ **Production Infrastructure**: Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Next Steps**: Use the main deployment workflow to deploy application code" >> $GITHUB_STEP_SUMMARY
